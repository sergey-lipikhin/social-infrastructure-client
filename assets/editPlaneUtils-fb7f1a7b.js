import{S as Re,aA as K,mT as Ft,mU as Ge,mV as ze,bE as O,cd as B,ck as oe,cl as $,cr as ae,cM as Mt,hJ as At,R as at,aD as De,aC as Fe,mW as re,aa as Rt,bs as Ae,aB as Ze,cX as ke,a5 as se,jk as A,mX as He,aP as Ue,mY as We,V as Le,u as l,a9 as le,mZ as F,bn as Ne,s as qe,v as p,w as P,aF as Ye,aI as Gt,m_ as gt,dv as yt,dA as je,l as L,E as D,F as Xe,br as Be,m$ as st,n0 as zt,jo as Je,dH as ht,n1 as ut,aO as mt,dz as pe,cb as Ke,ao as Zt,dE as ce,n2 as Qe,n3 as he,n4 as ue,bk as Ot,jP as de,lm as $t,bI as ge,gr as tn,n5 as en,n6 as nn,gp as on,kI as an,go as rn,jg as kt,hj as ye,a8 as me,ct as Et,bF as sn,ce as ot,n7 as Ht,hy as Ut,n8 as Wt,gY as Y,n9 as Lt,na as ln,nb as pn,c8 as cn,nc as _t,nd as Nt,ch as qt,hK as xt}from"./index-fdfa590d.js";import{t as Q,m as V,U as J,r as Yt,p as hn,s as wt,d as un,b as jt,c as lt}from"./automaticLengthMeasurementUtils-c72c5077.js";import{simplify as dn,distance as gn}from"./geometryEngine-5925e455.js";import{Q as yn,O as mn}from"./quat-95b41819.js";import{e as Xt}from"./quatf64-3363c48e.js";import{n as bt,t as it,c as M}from"./sphere-8d57d872.js";import{o as Bt,e as Pt,w as fn,_ as vn,p as _n,l as xn,t as wn,b as bn,s as Tn,c as Sn}from"./SnappingContext-b5c517d5.js";import{M as Mn,a as On,x as ft}from"./interfaces-3b2ddada.js";import{r as fe}from"./GraphicManipulator-2ea688b3.js";import{s as $n}from"./colorUtils-46453684.js";import{W as ve,J as En}from"./boundedPlane-b5f6b528.js";function It(e,t){return e===t||e!=null&&t!=null&&Re(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function dt(e,t,n=null){return n!=null?[e,t,n]:[e,t]}function v(e,t,n=null){return n!=null?{x:e,y:t,z:n}:{x:e,y:t}}let _e=class{constructor(t){this.spatialReference=t}mapToLocalMultiple(t){return t.map(n=>this.mapToLocal(n)).filter(at)}get doUnnormalization(){return!1}};class Pn extends _e{constructor(t,n,i=null){super(n),this._defaultZ=i,this.transform=Ft(),this.transformInv=Ft(),this.transform=Ge(t),ze(this.transformInv,this.transform)}makeMapPoint(t,n){return dt(t,n,this._defaultZ)}mapToLocal(t){return v(this.transform[0]*t[0]+this.transform[2]*t[1]+this.transform[4],this.transform[1]*t[0]+this.transform[3]*t[1]+this.transform[5])}localToMap(t){return dt(this.transformInv[0]*t.x+this.transformInv[2]*t.y+this.transformInv[4],this.transformInv[1]*t.x+this.transformInv[3]*t.y+this.transformInv[5],this._defaultZ)}}let In=class extends _e{constructor(t,n){super(t.spatialReference),this.view=t,this.defaultZ=null,this.pWS=O(),this.tangentFrameUpWS=O(),this.tangentFrameRightWS=O(),this.tangentFrameForwardWS=O(),this.localFrameRightWS=O(),this.localFrameUpWS=O(),this.worldToLocalTransform=Xt(),this.localToWorldTransform=Xt(),this.scale=1,this.scale=t.resolution,this.referenceMapPoint=n,this.defaultZ=n.hasZ?n.z:null;const i=t.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,bt.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,bt.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,bt.Z,this.tangentFrameForwardWS);const o=O();B(o,this.tangentFrameForwardWS,oe(i,this.tangentFrameForwardWS)),$(this.localFrameRightWS,i,o),ae(this.localFrameRightWS,this.localFrameRightWS),Mt(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),yn(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),mn(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return this.view.viewingMode==="global"}makeMapPoint(t,n){return dt(t,n,this.defaultZ)}mapToLocal(t){const n=O();this.view.renderCoordsHelper.toRenderCoords(new K({x:t[0],y:t[1],spatialReference:this.spatialReference}),n),At(n,n,this.worldToLocalTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference);return i!=null?v(i.x/this.scale,i.y/this.scale):null}localToMap(t){const n=O();this.view.renderCoordsHelper.toRenderCoords(new K({x:t.x*this.scale,y:t.y*this.scale,spatialReference:this.spatialReference}),n),At(n,n,this.localToWorldTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference);return i!=null?dt(i.x,i.y,this.defaultZ):null}};function Jt(e,t){if(e.type==="2d")return new Pn(e.state.transform,e.spatialReference,t.length>2?t[2]:null);if(e.type==="3d"){const n=t.length>2?new K({x:t[0],y:t[1],z:t[2],spatialReference:e.spatialReference}):new K({x:t[0],y:t[1],spatialReference:e.spatialReference});return new In(e,n)}return null}function N(e,t){const n=new K({x:e[0],y:e[1],spatialReference:t});return e.length>2&&(n.z=e[2]),n}function Vn(e,t){return new De({points:e,spatialReference:t})}function Kt(e,t,n){const i=new Fe({paths:e,spatialReference:t});return n&&re(i),i}function q(e,t,n,i=!0){const o=Rt(e);o.forEach(s=>{const r=s[0],c=s[s.length-1];Ae(r,c)&&s.length!==1||s.push(s[0])});let a=new Ze({rings:o,spatialReference:t});return a.rings.forEach(s=>{ke(s,!1,!1)||s.reverse()}),n&&re(a),i&&a.isSelfIntersecting&&se(t)&&(a=dn(a)),a}function Qt(e,t,n){const i=t.mapToLocalMultiple(e),o=[],a={x:i[0].x,y:i[0].y},s={x:i[1].x,y:i[1].y},r=Math.round(s.x-a.x),c=Math.round(s.y-a.y),d=Math.max(Math.abs(r),Math.abs(c));if(n){const h={x:a.x+d,y:a.y+d},g={x:a.x-d,y:a.y-d};o.push(v(h.x,g.y),v(g.x,g.y),v(g.x,h.y),v(h.x,h.y))}else{const h={x:r>0?a.x+d:a.x-d,y:c>0?a.y+d:a.y-d};o.push(v(a.x,a.y),v(h.x,a.y),v(h.x,h.y),v(a.x,h.y))}return xe(q([o.map(h=>t.localToMap(h)).filter(at)],t.spatialReference,t.doUnnormalization,!0),o,t)}function Cn(e,t,n){let i=t.mapToLocalMultiple(e);if(i.length===1){const c=i[0];i=[v(c.x-48,c.y+48),v(c.x+48,c.y-48),v(c.x+48,c.y-48),v(c.x-48,c.y+48)]}const o=[],a={x:i[0].x,y:i[0].y},s={x:i[1].x,y:i[1].y};if(n){const r=Math.round(s.x-a.x),c=Math.round(s.y-a.y);o.push(v(a.x-r,a.y-c),v(s.x,a.y-c),v(s.x,s.y),v(a.x-r,s.y))}else o.push(v(a.x,a.y),v(s.x,a.y),v(s.x,s.y),v(a.x,s.y));return xe(q([o.map(r=>t.localToMap(r)).filter(at)],t.spatialReference,t.doUnnormalization,!0),o,t)}function xe(e,t,n){const i=pt(t[3],t[2],n),o=pt(t[1],t[2],n),a=pt(t[0],t[1],n),s=pt(t[0],t[3],n);return{geometry:e,midpoints:i!=null&&o!=null&&a!=null&&s!=null?{top:i,right:o,bottom:a,left:s}:null}}function pt(e,t,n){j[0]=e.x,j[1]=e.y,j[2]=0,X[0]=t.x,X[1]=t.y,X[2]=0,A(j,j,X,.5),ct.x=j[0],ct.y=X[1],ct.z=X[2];const i=n.localToMap(ct);return i!=null?N(i,n.spatialReference):null}const ct=v(0,0,0),j=O(),X=O();function te(e,t,n,i){const o=t.mapToLocalMultiple(e);let a=null,s=null;if(n)a=o[0],s=o[1];else{const _=o[0],f=o[1],w=Math.round(f.x-_.x),T=Math.round(f.y-_.y),S=Math.max(Math.abs(w),Math.abs(T));a=v(w>0?_.x+S/2:_.x-S/2,T>0?_.y+S/2:_.y-S/2),s=v(Math.abs(w)>Math.abs(T)?a.x-S/2:a.x,Math.abs(w)>Math.abs(T)?a.y:a.y-S/2)}const r=t.localToMap(a),c=t.localToMap(s);if(r==null||c==null)return null;t.doUnnormalization&&He([[r,c]],t.spatialReference);const d=N(r,t.spatialReference),h=N(c,t.spatialReference),g=Ue(t.spatialReference);let m=0;if(se(t.spatialReference))m=g*gn(d,h,null);else{const _=a.x-s.x,f=a.y-s.y;m=g*Math.sqrt(_*_+f*f)*(i||1)}const u=new We({center:d,radius:m,radiusUnit:"meters",spatialReference:t.spatialReference});return{geometry:q(u.rings,u.spatialReference,!1),center:d,edge:h}}function Rn(e,t,n){const i=t.mapToLocalMultiple(e),o=i[0],a=i[1],s=Math.round(a.x-o.x),r=Math.round(a.y-o.y),c=v(n?o.x:o.x+s/2,n?o.y:o.y+r/2),d=n?s:s/2,h=n?r:r/2,g=60,m=[],u=2*Math.PI/g;function _(E){const nt=Math.cos(E),rt=Math.sin(E);return v(d*nt+c.x,h*rt+c.y)}for(let E=0;E<g;E++)m.push(_(E*u));m.push(m[0]);const{spatialReference:f,doUnnormalization:w}=t,T=q([m.map(E=>t.localToMap(E)).filter(at)],f,w,!1),S=t.localToMap(_(Math.PI/2)),C=t.localToMap(_(0)),tt=t.localToMap(_(-Math.PI/2)),et=t.localToMap(_(Math.PI));return{geometry:T,midpoints:S!=null&&C!=null&&tt!=null&&et!=null?{top:N(S,f),right:N(C,f),bottom:N(tt,f),left:N(et,f)}:null}}var W;(function(e){e[e.WhenToolEditable=0]="WhenToolEditable",e[e.WhenToolNotEditable=1]="WhenToolNotEditable",e[e.Always=2]="Always"})(W||(W={}));class Gn{constructor(){this._isToolEditable=!0,this._manipulators=new Le,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,n=W.WhenToolEditable){this.addMany([t],n)}addMany(t,n=W.WhenToolEditable){for(const i of t){const o={manipulator:i,visibilityPredicate:n,attached:!1};this._manipulators.add(o),this._attached&&this._updateManipulatorAttachment(o)}}remove(t){for(let n=0;n<this._manipulators.length;n++)if(this._manipulators.at(n).manipulator===t){const i=this._manipulators.splice(n,1)[0];this._detachManipulator(i);break}}removeAll(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(t=>{this._updateManipulatorAttachment(t)}),this._attached=!0}detach(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach(({manipulator:t})=>{t.destroy&&t.destroy()}),this._manipulators.destroy(),this._resourceContexts=null}on(t,n){return this._manipulators.on(t,i=>{n(i)})}forEach(t){for(const n of this._manipulators.items)t(n)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach(n=>t.push(n.manipulator)),t}intersect(t,n){let i=null,o=Number.MAX_VALUE;return this._manipulators.forEach(({manipulator:a,attached:s})=>{if(!s||!a.interactive)return;const r=a.intersectionDistance(t,n);r!=null&&r<o&&(o=r,i=a)}),i}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const n=t.manipulator;n.grabbing=!1,n.dragging=!1,n.hovering=!1,n.selected=!1,n.detach&&n.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===W.Always||(this._isToolEditable?t.visibilityPredicate===W.WhenToolEditable:t.visibilityPredicate===W.WhenToolNotEditable)}}let b=class extends le{constructor(t){super(t),this.manipulators=new Gn,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[F.MANAGER,!0],[F.USER,!0]]),this._creationFinishedResolver=Ne()}get active(){return this.view!=null&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(F.USER)}set editable(t){this.setEditableFlag(F.USER,t)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){this.view!=null?(this.view.focus(),this.onActivate()):qe.getLogger(this).error("Can't activate tool if view is not defined.")}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,n){this._editableFlags.set(t,n),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===F.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){return this._editableFlags.get(t)??!1}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(F.USER)&&this.getEditableFlag(F.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized){if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};l([p({constructOnly:!0})],b.prototype,"view",void 0),l([p({readOnly:!0})],b.prototype,"active",null),l([p({value:!0})],b.prototype,"visible",null),l([p({value:!0})],b.prototype,"editable",null),l([p({readOnly:!0})],b.prototype,"manipulators",void 0),l([p({readOnly:!0})],b.prototype,"updating",null),l([p()],b.prototype,"cursor",null),l([p({readOnly:!0})],b.prototype,"automaticManipulatorSelection",void 0),l([p()],b.prototype,"hasFocusedManipulators",null),l([p()],b.prototype,"hasGrabbedManipulators",void 0),l([p()],b.prototype,"hasHoveredManipulators",void 0),l([p()],b.prototype,"firstGrabbedManipulator",void 0),l([p({readOnly:!0})],b.prototype,"created",void 0),l([p({readOnly:!0})],b.prototype,"removeIncompleteOnCancel",void 0),b=l([P("esri.views.interactive.InteractiveToolBase")],b);let Z=class extends Q{constructor(t){super(t),this.type="draw-point"}};l([p()],Z.prototype,"type",void 0),l([p()],Z.prototype,"elevation",void 0),l([p()],Z.prototype,"viewType",void 0),l([p()],Z.prototype,"helpMessage",void 0),Z=l([P("esri.views.interactive.tooltip.DrawPointTooltipInfo")],Z);let R=class extends Q{constructor(t){super(t),this.type="draw-polyline",this.totalLength=V}};l([p()],R.prototype,"type",void 0),l([p()],R.prototype,"elevation",void 0),l([p()],R.prototype,"totalLength",void 0),l([p()],R.prototype,"viewType",void 0),l([p()],R.prototype,"helpMessage",void 0),R=l([P("esri.views.interactive.tooltip.DrawPolylineTooltipInfo")],R);let G=class extends Q{constructor(e){super(e),this.type="draw-polygon",this.area=J}};l([p()],G.prototype,"type",void 0),l([p()],G.prototype,"elevation",void 0),l([p()],G.prototype,"area",void 0),l([p()],G.prototype,"viewType",void 0),l([p()],G.prototype,"helpMessage",void 0),G=l([P("esri.views.interactive.tooltip.DrawPolygonTooltipInfo")],G);let k=class extends Q{constructor(t){super(t),this.type="draw-mesh"}};l([p()],k.prototype,"type",void 0),l([p()],k.prototype,"elevation",void 0),l([p()],k.prototype,"viewType",void 0),l([p()],k.prototype,"helpMessage",void 0),k=l([P("esri.views.interactive.tooltip.DrawMeshTooltipInfo")],k);let H=class extends Q{constructor(t){super(t),this.type="draw-rectangle",this.xSize=V,this.ySize=V,this.area=J}};l([p()],H.prototype,"type",void 0),l([p()],H.prototype,"xSize",void 0),l([p()],H.prototype,"ySize",void 0),l([p()],H.prototype,"area",void 0),H=l([P("esri.views.interactive.tooltip.DrawRectangleTooltipInfo")],H);let z=class extends Q{constructor(e){super(e),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=J}};l([p()],z.prototype,"type",void 0),l([p()],z.prototype,"radius",void 0),l([p()],z.prototype,"xSize",void 0),l([p()],z.prototype,"ySize",void 0),l([p()],z.prototype,"area",void 0),z=l([P("esri.views.interactive.tooltip.DrawCircleTooltipInfo")],z);let zn=class{constructor(){this.regularVertices=null,this.activeVertex=null,this.full=null,this.outline=null,this.circle=null,this.rectangle=null}},y=class extends Ye(Gt.EventedMixin(b)){constructor(t){super(t),this._graphic=null,this._createOperationGeometry=null,this.defaultZ=0,this.geometryType=null,this.hasZ=!0,this.labelOptions=new gt,this.geometryToPlace=null,this.mode=null,this.snappingManager=null,this.snapToScene=!1,this.tooltip=null,this.tooltipOptions=new yt}initialize(){this.internalGraphicsLayer=new je({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",t=>this.onVertexAdd(t)),this.drawOperation.on("vertex-remove",t=>this.onVertexRemove(t)),this.drawOperation.on("vertex-update",t=>this.onVertexUpdate(t)),this.drawOperation.on("cursor-update",t=>this.onCursorUpdate(t)),this.drawOperation.on("complete",t=>this.onComplete(t)),L(()=>this.tooltipOptions.enabled,t=>{this.tooltip=t?new un({view:this.view,info:this._tooltipInfo}):D(this.tooltip)},ht),L(()=>this._tooltipInfo,t=>{this.tooltip!=null&&(this.tooltip.info=t)},ht)]),this.finishToolCreation()}destroy(){this.drawOperation=D(this.drawOperation),this.tooltip=D(this.tooltip),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=D(this.internalGraphicsLayer),this._set("view",null)}get _defaultElevation(){return Yt(this.defaultZ,"meters")}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),this._graphic!=null&&(this._graphic.symbol=t)}get updating(){var t;return((t=this.drawOperation)==null?void 0:t.updating)??!1}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}_destroyAllVisualisations(){this.handles.remove(I.outline),this.handles.remove(I.regularVertices),this.handles.remove(I.activeVertex),this.handles.remove(Tt)}_createOrUpdateGraphic(t){if(this._graphic!=null)return this._updateGraphicGeometry(this._graphic,t),this._graphic;const n=this._graphic=new Xe({...this.graphicProperties,symbol:this.graphicSymbol});return this._updateGraphicGeometry(n,t),this.internalGraphicsLayer.add(n),this.handles.add(this.initializeGraphic(n)),this.notifyChange("graphic"),this.handles.add(Be(()=>{this.internalGraphicsLayer.remove(n),D(n),this._graphic===n&&(this._graphic=null)}),Tt),n}_updateGraphicGeometry(t,n){t.geometry=n}_getCreateOperationGeometry(t={operationComplete:!1}){var _;const{drawOperation:n}=this;if(n==null||n.numVertices===0)return null;const{coordinateHelper:i,view:o}=n,a=n.stagedVertex,s=n.committedVertices,r=s.slice(),c=a!=null;c&&r.push(i.pointToArray(a));const d=c?i.pointToArray(a):s.splice(-1)[0],h=r.length,g=o.spatialReference,m=o.type==="3d"&&o.viewingMode==="global",u=new zn;switch(this.geometryType){case"point":case"mesh":u.regularVertices=s,u.activeVertex=d,u.full=i.arrayToPoint(r[0]);break;case"multipoint":u.regularVertices=s,u.activeVertex=d,h>0&&(u.full=Vn(r,g));break;case"polyline":u.regularVertices=s,u.activeVertex=d,h>0&&(u.full=Kt([r],g,m));break;case"polygon":u.regularVertices=s,u.activeVertex=d,h>0&&(u.full=q([r],g,m,!0));break;case"circle":if(h>0){const f=Jt(o,r[0]);if(h===1&&t.operationComplete){const w=r[0],T=f.makeMapPoint(w[0]+ee*o.resolution,w[1]);u.circle=te([w,T],f,!0),u.full=u.circle!=null?u.circle.geometry:null}else h===2&&(this.forceUniformSize?(u.circle=te(r,f,this.centered),u.full=u.circle!=null?u.circle.geometry:null):(u.rectangle=Rn(r,f,this.centered),u.full=u.rectangle.geometry))}break;case"rectangle":if(h>0){const f=Jt(o,r[0]);if(h===1&&t.operationComplete){const w=r[0],T=f.makeMapPoint(w[0]+ee*o.resolution,w[1]);u.rectangle=Qt([w,T],f,!0),u.full=u.rectangle.geometry}else h===2&&(u.rectangle=this.forceUniformSize?Qt(r,f,this.centered):Cn(r,f,this.centered),u.full=u.rectangle.geometry)}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":u.outline=h>1?Kt([r],g,m):null;break;case"polygon":u.outline=h>1?q([r],g,m):null;break;case"circle":case"rectangle":u.outline=((_=u.full)==null?void 0:_.type)==="polygon"?q(u.full.rings,g,m):null}return u}initializeGraphic(t){return null}onComplete(t){this._updateGraphic();let n=null;if(this.drawOperation.isCompleted){const i=this._getCreateOperationGeometry({operationComplete:!0});i!=null&&(n=this._createOrUpdateGraphic(i.full).clone())}this._createOperationGeometry=null,this.emit("complete",{graphic:n,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}onVertexAdd(t){this._updateGraphic(),this.emit("vertex-add",t)}onVertexRemove(t){this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,t!=null?(t.outline!=null?this.handles.add(this.onOutlineChanged(t.outline),I.outline):this.handles.remove(I.outline),t.regularVertices!=null?this.handles.add(this.onRegularVerticesChanged(t.regularVertices),I.regularVertices):this.handles.remove(I.regularVertices),t.activeVertex!=null?this.handles.add(this.onActiveVertexChanged(t.activeVertex),I.activeVertex):this.handles.remove(I.activeVertex),t.full!=null?this._createOrUpdateGraphic(t.full):this.handles.remove(Tt)):this._destroyAllVisualisations()}get _tooltipInfo(){const{drawOperation:t}=this;if(!t)return null;switch(this.geometryType){case"point":return this._drawPointTooltipInfo;case"polyline":return this._drawPolylineTooltipInfo;case"polygon":return this._drawPolygonTooltipInfo;case"rectangle":return this._drawRectangleTooltipInfo;case"circle":return this._drawCircleTooltipInfo;case"mesh":return this._drawMeshTooltipInfo;default:return null}}get _drawPointTooltipInfo(){const{view:t,graphic:n}=this,i=n==null?void 0:n.geometry;return(i==null?void 0:i.type)!=="point"||t.type==="2d"&&this.defaultZ===0?null:new Z({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:t.type,helpMessage:st("point",i,t)})}get _drawPolylineTooltipInfo(){const t=this._createOperationGeometry,n=t!=null?t.full:null;if((n==null?void 0:n.type)!=="polyline")return null;const i=hn(n,this._elevationMode),{view:o}=this;return new R({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,totalLength:i??V,viewType:o.type,helpMessage:st("polyline",n,o)})}get _drawPolygonTooltipInfo(){const t=this._createOperationGeometry,n=t!=null?t.full:null;if((n==null?void 0:n.type)!=="polygon")return null;const i=Bt(n,this._elevationMode),{view:o}=this;return new G({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,area:i??J,viewType:o.type,helpMessage:st("polygon",n,o)})}get _drawMeshTooltipInfo(){const{view:t,graphic:n}=this,i=n==null?void 0:n.geometry;return(i==null?void 0:i.type)!=="mesh"||t.type==="2d"&&this.defaultZ===0?null:new k({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:t.type,helpMessage:st("mesh",i,t)})}get _drawRectangleTooltipInfo(){return this.drawOperation==null?null:new H({tooltipOptions:this.tooltipOptions,xSize:this._xSize??V,ySize:this._ySize??V,area:this._fullGeometryArea??J})}get _drawCircleTooltipInfo(){if(this.drawOperation==null)return null;const t=this.forceUniformSize;return new z({tooltipOptions:this.tooltipOptions,radius:t?this._circleRadius??V:null,xSize:t?null:this._xSize??V,ySize:t?null:this._ySize??V,area:this._fullGeometryArea??J})}get _circleRadius(){const t=this._createOperationGeometry;return t!=null&&t.circle!=null&&t.circle.center!=null&&t.circle.edge!=null?wt(t.circle.center,t.circle.edge,this._elevationMode):null}get _xSize(){const t=this._createOperationGeometry;if((t==null?void 0:t.rectangle)==null)return null;const{midpoints:n}=t.rectangle;return n!=null?wt(n.left,n.right,this._elevationMode):null}get _ySize(){const t=this._createOperationGeometry;if((t==null?void 0:t.rectangle)==null)return null;const{midpoints:n}=t.rectangle;return n!=null?wt(n.top,n.bottom,this._elevationMode):null}get _fullGeometryArea(){const t=this._createOperationGeometry,n=t!=null?t.full:null;return(n==null?void 0:n.type)!=="polygon"?null:Bt(n,this._elevationMode)}get _elevationTooltipDetail(){return{mode:this.drawOperation.elevationInfo.mode,...this._vertexTooltipElevation}}get _vertexTooltipElevation(){const{tooltipOptions:t,view:n,drawOperation:i}=this;if(i==null)return this._defaultElevation;const o=i.stagedVertex??i.lastVertex;if(o==null||n.type==="2d")return this._defaultElevation;const a={mode:t.elevation.mode,offset:0},s=(zt(n,o,i.elevationInfo,a)??0)*Je(o.spatialReference);return Yt(s,"meters")}get _elevationMode(){return this.drawOperation.isDraped?"on-the-ground":"absolute-height"}};l([p()],y.prototype,"_createOperationGeometry",void 0),l([p()],y.prototype,"_defaultElevation",null),l([p({value:!0})],y.prototype,"centered",null),l([p({nonNullable:!0})],y.prototype,"defaultZ",void 0),l([p()],y.prototype,"drawOperation",void 0),l([p({value:!0})],y.prototype,"enabled",null),l([p({value:!0})],y.prototype,"forceUniformSize",null),l([p({constructOnly:!0})],y.prototype,"geometryType",void 0),l([p()],y.prototype,"graphic",null),l([p({constructOnly:!0})],y.prototype,"graphicProperties",void 0),l([p()],y.prototype,"graphicSymbol",null),l([p({constructOnly:!0})],y.prototype,"hasZ",void 0),l([p({constructOnly:!0,type:gt})],y.prototype,"labelOptions",void 0),l([p({constructOnly:!0})],y.prototype,"geometryToPlace",void 0),l([p({constructOnly:!0})],y.prototype,"mode",void 0),l([p()],y.prototype,"snappingManager",void 0),l([p()],y.prototype,"snapToScene",void 0),l([p()],y.prototype,"tooltip",void 0),l([p({constructOnly:!0,type:yt})],y.prototype,"tooltipOptions",void 0),l([p({readOnly:!0})],y.prototype,"type",void 0),l([p({readOnly:!0})],y.prototype,"updating",null),l([p({constructOnly:!0,nonNullable:!0})],y.prototype,"view",void 0),l([p()],y.prototype,"_tooltipInfo",null),l([p()],y.prototype,"_drawPointTooltipInfo",null),l([p()],y.prototype,"_drawPolylineTooltipInfo",null),l([p()],y.prototype,"_drawPolygonTooltipInfo",null),l([p()],y.prototype,"_drawMeshTooltipInfo",null),l([p()],y.prototype,"_drawRectangleTooltipInfo",null),l([p()],y.prototype,"_drawCircleTooltipInfo",null),l([p()],y.prototype,"_circleRadius",null),l([p()],y.prototype,"_xSize",null),l([p()],y.prototype,"_ySize",null),l([p()],y.prototype,"_fullGeometryArea",null),l([p()],y.prototype,"_elevationTooltipDetail",null),l([p()],y.prototype,"_vertexTooltipElevation",null),l([p()],y.prototype,"_elevationMode",null),y=l([P("esri.views.draw.DrawGraphicTool")],y);const Tt="create-operation-graphic",I={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function Mi(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const ee=48,we="click";let Dn=class{constructor({grabbableForEvent:t}){this.events=new Gt,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=t}intersectionDistance(t,n){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};function Fn(e,t){let n=null,i=null;return o=>{if(o.action==="cancel")return void(i!=null&&(i.execute({action:"cancel"}),n=null,i=null));const a={action:o.action,screenStart:o.start,screenEnd:o.screenPoint};o.action==="start"&&n==null&&(n=new Vt,i=new Vt,t(e,n,i,o.pointerType,a)),n!=null&&n.execute(a),o.action==="end"&&n!=null&&(n=null,i=null)}}function St(e,t){return e.events.on("drag",Fn(e,t))}function $i(e,t){const n=[e.x,e.y,e.z??0],i=t,o=[Math.cos(i),Math.sin(i)],a=Math.sqrt(o[0]*o[0]+o[1]*o[1]);if(a===0)return null;o[0]/=a,o[1]/=a;const s=r=>{const c=(r.x-n[0])*o[0]+(r.y-n[1])*o[1];r.x=n[0]+c*o[0],r.y=n[1]+c*o[1]};return r=>(s(r.mapStart),s(r.mapEnd),{...r,axis:o})}function An(e,t){let n=null;return i=>{if(i.action==="start"&&(n=Zn(e,i.mapStart.spatialReference,t)),n==null)return null;const o=i.mapEnd.x-i.mapStart.x,a=i.mapEnd.y-i.mapStart.y,s=i.mapEnd.z-i.mapStart.z;return n.move(o,a,s,i.action),{...i,translationX:o,translationY:a,translationZ:s}}}function be(e,t){return e==null?null:e.spatialReference.equals(t)?e.clone():mt(e,t)}function Zn(e,t,n){const i=e.geometry,o=Mn(t);if(i==null)return null;if(i.type==="mesh")return kn(e,i,o,n);const a=be(i,o),s=i.spatialReference;return a==null?null:{move:(r,c,d)=>{const h=fe(a.clone(),r,c,d);h.spatialReference.equals(s)?e.geometry=h:e.geometry=mt(h,s)}}}function kn(e,t,n,i){if(t.vertexSpace.isRelative)return Hn(e,t,t.vertexSpace,n);if(!t.spatialReference.equals(n))return null;let o=0,a=0,s=0;return{move:(r,c,d)=>{const h=r-o,g=c-a,m=d-s;if(h||g||m){const u=new K(t.origin.x+h,t.origin.y+g,(t.origin.z??0)+m,t.origin.spatialReference);t.centerAt(u,{geographic:t.vertexSpace.isRelative?void 0:i===pe.Global}),e.notifyGeometryChanged(),o=r,a=c,s=d}}}}function Hn(e,t,n,i){const o=be(n.getOriginPoint(t.spatialReference),i),a=t.spatialReference;return o==null?null:{move:(s,r,c,d)=>{const h=fe(o.clone(),s,r,c);if(h.spatialReference.equals(a))n.setOriginFormPoint(h);else{const g=mt(h,a);g!=null&&n.setOriginFormPoint(g)}if(n.isGeoreferenced)e.notifyGeometryChanged();else{const g=d==="end";e.notifyMeshTransformChanged(g?{action:On.UpdateFastLocalOrigin}:{})}}}}function Ei(e,t=null,n){var s;let i=null;const o=t==null||(s=e.spatialReference)!=null&&s.equals(t)?r=>r:r=>r!=null?mt(r,t):r,a={exclude:[],...n};return r=>{if(r.action==="start"&&(i=o(e.toMap(r.screenStart,a))),i==null)return null;const c=o(e.toMap(r.screenEnd,a));return c!=null?{...r,mapStart:i,mapEnd:c}:null}}function Pi(e,t){const n=e.map(i=>An(i,t)).filter(at);return i=>{const o=i.mapEnd.x-i.mapStart.x,a=i.mapEnd.y-i.mapStart.y,s=i.mapEnd.z-i.mapStart.z;return n.forEach(r=>r(i)),{...i,translationX:o,translationY:a,translationZ:s}}}function Un(e,t){const n=new Map;for(const i of t)n.set(i,Rt(e[i]));return i=>(n.forEach((o,a)=>{e[a]=o}),i)}function Wn(e){return e.geometry!=null&&e.geometry.type==="mesh"?Ln(e,e.geometry):Un(e,["geometry"])}function Ln(e,t){var a;const{vertexSpace:n}=t;if(n.isGeoreferenced){const s=t.vertexAttributes.clonePositional();return r=>(t.vertexAttributes=s,e.notifyGeometryChanged(),r)}const i=Ke(n.origin),o=(a=t.transform)==null?void 0:a.clone();return s=>(t.transform=o,t.vertexSpace.origin=i,e.notifyMeshTransformChanged(),s)}function Ii(e){const t=e.map(n=>Wn(n)).filter(n=>n!=null);return n=>(t.forEach(i=>i(n)),n)}function Vi(){let e=0,t=0,n=0;return i=>{i.action==="start"&&(e=i.mapStart.x,t=i.mapStart.y,n=i.mapStart.z);const o=i.mapEnd.x-e,a=i.mapEnd.y-t,s=i.mapEnd.z-n;return e=i.mapEnd.x,t=i.mapEnd.y,n=i.mapEnd.z,{...i,mapDeltaX:o,mapDeltaY:a,mapDeltaZ:s,mapDeltaSpatialReference:i.mapStart.spatialReference}}}function Ci(){let e=0,t=0;return n=>{n.action==="start"&&(e=n.screenStart.x,t=n.screenStart.y);const i=n.screenEnd.x-e,o=n.screenEnd.y-t;return e=n.screenEnd.x,t=n.screenEnd.y,{...n,screenDeltaX:i,screenDeltaY:o}}}function Ri(e,t){let n=null,i=0,o=0;return a=>{var d;if(a.action==="start"&&(n=(d=e.toScreen)==null?void 0:d.call(e,t),n!=null&&(n.x<0||n.x>e.width||n.y<0||n.y>e.height?n=null:(i=a.screenStart.x-n.x,o=a.screenStart.y-n.y))),n==null)return null;const s=Zt(a.screenEnd.x-i,0,e.width),r=Zt(a.screenEnd.y-o,0,e.height),c=ce(s,r);return a.screenStart=n,a.screenEnd=c,a}}const Nn=()=>{};let Vt=class Te{constructor(){this.execute=Nn}next(t,n=new Te){return t!=null&&(this.execute=i=>{const o=t(i);o!=null&&n.execute(o)}),n}};function qn(e,t,n=[]){if(e.type==="2d")return o=>o;let i=null;return o=>{o.action==="start"&&(i=e.toMap(o.screenStart,{exclude:n}),i!=null&&(i.z=ut(i,e,t)));const a=e.toMap(o.screenEnd,{exclude:n});a!=null&&(a.z=ut(a,e,t));const s=i!=null&&a!=null?{sceneStart:i,sceneEnd:a}:null;return{...o,scenePoints:s}}}function ne(e,t,n){const i=t.elevationProvider.getElevation(e.x,e.y,e.z??0,e.spatialReference,"scene")??0,o=ft(e);return o.z=i,o.hasZ=!0,o.z=ut(o,t,n),o}function Gi(e,t){if(e.type==="2d")return i=>i;let n=null;return i=>{i.action==="start"&&(n=ne(i.mapStart,e,t));const o=ne(i.mapEnd,e,t),a=n!=null&&o!=null?{sceneStart:n,sceneEnd:o}:null;return{...i,scenePoints:a}}}function Yn({predicate:e=()=>!0,snappingManager:t,snappingContext:n,updatingHandles:i,useZ:o=!0}){const a=new Vt;if(t==null)return{snappingStep:[ie,a],cancelSnapping:ie};let s,r=null,c=null,d=null;const h=()=>{r=Ot(r),t.doneSnapping(),c!=null&&c.frameTask.remove(),c=null,s=de(s),d=null},g=jn(t,o,a);let m=null,u=null,_=null;return{snappingStep:[f=>{if(!e(f))return f;const{action:w}=f;if(w==="start"){const{info:T}=f,S=Xn(t.view);if(c=Bn(n,f,S),c.context.selfSnappingZ=null,!o&&T!=null){const C=Kn(n.coordinateHelper,T.handle.component);C!=null&&(c.context.selfSnappingZ={value:C,elevationInfo:n.elevationInfo??Qe})}}if(c!=null){const{context:T,originalScenePos:S,originalPos:C}=c,{mapEnd:tt,mapStart:et,scenePoints:E}=f,nt=Se(C,Ct(tt,et)),rt=Ct(et,C),Pe={...f,action:"update"},Ie=c.context,vt=Jn(S,E),Dt=t.update({point:nt,scenePoint:vt,context:T});if(_=Dt,Me(tt,Dt,rt,o),m=nt,u=vt,w!=="end"){const{frameTask:Ve}=c;r==null&&(r=new AbortController),d=Ce=>{i.addPromise($t(g({frameTask:Ve,event:Pe,context:Ie,point:nt,scenePoint:vt,delta:rt,getLastState:()=>({point:m,scenePoint:u,updatePoint:Ce.forceUpdate?null:_})},r.signal)))},d({forceUpdate:!1}),s==null&&(s=L(()=>t.options.effectiveEnabled,()=>d==null?void 0:d({forceUpdate:!0})))}}return w==="end"&&h(),f},a],cancelSnapping:f=>(h(),f)}}function jn(e,t,n){return ge(async({frameTask:i,point:o,scenePoint:a,context:s,event:r,delta:c,getLastState:d},h)=>{const g=await i.schedule(()=>e.snap({point:o,scenePoint:a,context:s,signal:h}),h);if(g.valid){let m=await i.schedule(()=>g.apply(),h);const u=d();u.point!=null&&o!==u.point&&(m=e.update({point:u.point,scenePoint:u.scenePoint,context:s})),u.updatePoint!=null&&It(m,u.updatePoint)||(Me(r.mapEnd,m,c,t),n.execute(r))}})}function Xn(e){return e.type==="3d"?e.resourceController.scheduler.registerTask(he.SNAPPING):ue}function Bn(e,t,n){return{context:new Pt({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:t.info!=null?t.info.handle:null,excludeFeature:e.excludeFeature,visualizer:e.visualizer}),originalPos:t.snapOrigin!=null?e.coordinateHelper.vectorToDehydratedPoint(t.snapOrigin):t.mapStart,originalScenePos:t.scenePoints!=null?t.scenePoints.sceneStart:null,frameTask:n}}function Se(e,[t,n,i]){const o=ft(e);return o.x+=t,o.y+=n,o.hasZ&&(o.z+=i),o}function Jn(e,t){return e==null||t==null?null:Se(e,Ct(t.sceneEnd,t.sceneStart))}function Ct(e,t){const n=e.hasZ&&t.hasZ?e.z-t.z:0;return[e.x-t.x,e.y-t.y,n]}function Me(e,t,[n,i,o],a){e.x=t.x+n,e.y=t.y+i,a&&e.hasZ&&t.hasZ&&(e.z=t.z+o)}function Kn(e,t){if(!e.hasZ())return null;const n=t.vertices;let i=null;for(const o of n){const a=e.getZ(o.pos);if(i!=null&&a!=null&&Math.abs(a-i)>1e-6)return null;i==null&&(i=a)}return i}function ie(e){return e}let U=class extends le{constructor(e){super(e),this.constrainResult=t=>t,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=ge(async(t,n,i,o)=>{const a=this._frameTask;if(a==null)return;const s=await a.schedule(()=>n.snap({...t,context:i,signal:o}),o);s.valid&&await a.schedule(()=>{this.stagedPoint=s.apply(),t!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=n.update({...this._snapPoints,context:i}))},o)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(e){this._stagedPoint=this.constrainResult(e)}initialize(){var t,n;const e=this.view.type==="3d"?(n=(t=this.view)==null?void 0:t.resourceController)==null?void 0:n.scheduler:null;this._frameTask=e!=null?e.registerTask(he.SNAPPING):ue}destroy(){this._abortController=Ot(this._abortController),this._frameTask=de(this._frameTask)}update(e,t,n){this._snapPoints=e;const{point:i,scenePoint:o}=e,a=t.update({point:i,scenePoint:o,context:n});return this.stagedPoint=a,a}async snap(e,t,n){const{point:i,scenePoint:o}=e;return this.stagedPoint=t.update({point:i,scenePoint:o,context:n}),this._snapPoints=e,this._abortController==null&&(this._abortController=new AbortController),this._snap(e,t,n,this._abortController.signal)}async resnap(e,t){this._snapPoints!=null&&await this.snap(this._snapPoints,e,t)}abort(){this._abortController=Ot(this._abortController),this._snapPoints=null}};l([p({constructOnly:!0})],U.prototype,"view",void 0),l([p()],U.prototype,"stagedPoint",null),l([p()],U.prototype,"constrainResult",void 0),l([p()],U.prototype,"_stagedPoint",void 0),U=l([P("esri.views.interactive.snapping.SnappingOperation")],U);let x=class extends Gt.EventedMixin(tn){constructor(e){super(e),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this._stagedScreenPoint=null,this._stagedPointerType=null,this.isDraped=!0,this.labelOptions=new gt,this.tooltipOptions=new yt,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.lastVertex=null,e.elevationInfo==null&&(this.elevationInfo=en(!!e.hasZ))}initialize(){const{geometryType:e,view:t}=this,n=t.spatialReference,i="viewingMode"in t.state?t.state.viewingMode:pe.Local,o=e==="segment"||e==="multipoint"?"polyline":e;this.coordinateHelper=fn(this.hasZ,this.hasM,n),this._editGeometryOperations=new vn(new _n(o,this.coordinateHelper)),this._snappingOperation=new U({view:t,constrainResult:r=>{var c;return r==null?r:(c=this._getEffectiveDrawSurface())==null?void 0:c.constrainZ(r)}}),this.addHandles([L(()=>this.stagedVertex,r=>{r!=null&&this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(r)}],operation:"apply",type:"vertex-update"})},{sync:!0,equals:(r,c)=>an(r,c,It)}),L(()=>this.view.viewpoint,(r,c)=>{r&&c&&rn(r,c)&&this._onViewpointChange()})]),this._activeComponent=new xn(n,i),this._editGeometryOperations.data.components.push(this._activeComponent);const a=this.segmentLabels;a!=null&&(a.context={view:t,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.addHandles([L(()=>this.labelOptions.enabled,r=>{a.visible=r},ht),this.on("cursor-update",()=>{const r=this.stagedVertex;a.stagedVertex=r!=null?this.coordinateHelper.pointToVector(r):null})])),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],r=>{const c=r.vertices.map(m=>({componentIndex:0,vertexIndex:m.index,coordinates:this.coordinateHelper.vectorToArray(m.pos)})),d=c.map(m=>m.coordinates);switch(r.type){case"vertex-add":this.emit(r.type,{...r,added:d,vertices:c});break;case"vertex-update":this.emit(r.type,{...r,updated:d,vertices:c});break;case"vertex-remove":this.emit(r.type,{...r,removed:d,vertices:c})}const h=this._activeComponent.getLastVertex(),g=h!=null?this.coordinateHelper.vectorToDehydratedPoint(h.pos):null;g!=null&&this.lastVertex!=null&&It(this.lastVertex,g)||(this.lastVertex=g)}));const s=this._manipulator=new Dn({grabbableForEvent:r=>this.drawingMode!=="click"||r.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(s),s.grabbable=e!=="point",this.addHandles([this._createManipulatorDragPipeline(s),s.events.on("immediate-click",r=>this._onImmediateClick(r)),s.events.on("immediate-double-click",r=>this._onImmediateDoubleClick(r)),L(()=>({cursor:this.cursor,loading:this.loading}),({cursor:r,loading:c})=>{s.cursor=c?"progress":r},ht)]),nn(this,()=>{const r=this.view.inputManager.latestPointerType??"mouse",c=this._getSnappingContext(r);this.snappingManager!=null&&this.updatingHandles.addPromise($t(this._snappingOperation.resnap(this.snappingManager,c)))})}destroy(){D(this.segmentLabels),D(this._snappingOperation),this._editGeometryOperations=D(this._editGeometryOperations)}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const e=this._getEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==e}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map(e=>this.coordinateHelper.vectorToArray(e.pos))}set drawingMode(e){this._set("drawingMode",e??we)}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return this.stagedVertex!=null?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get stagedVertex(){return this._snappingOperation.stagedPoint}set stagedVertex(e){this._snappingOperation.stagedPoint=Rt(e)}get updating(){return this.updatingHandles.updating}get vertices(){const e=this.committedVertices;return this.stagedVertex!=null&&e.push(this.coordinateHelper.pointToArray(this.stagedVertex)),e}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingOperation.abort(),this.stagedVertex!=null){const{stagedVertex:e}=this;this.stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e))}}complete(e){const t=e&&e.aborted||!1;this._snappingOperation.abort(),this.snappingManager!=null&&this.snappingManager.doneSnapping(),this.geometryType==="segment"||this.geometryType==="point"?this.commitStagedVertex():this.stagedVertex=null;const n=this.geometryType==="multipoint"&&this.numVertices===0||this.geometryType==="polyline"&&this.numVertices<2||this.geometryType==="polygon"&&this.numVertices<3;this._createOperationCompleted=!n,(this.isCompleted||t)&&this.emit("complete",{vertices:this.vertices.map((i,o)=>({componentIndex:0,vertexIndex:o,coordinates:i})),aborted:t,type:"complete"})}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(e){const t=this._activeComponent;if(this.geometryType==="polygon"&&t.vertices.length>2){if(this._vertexWithinPointerDistance(t.vertices[0].pos,e))return 0;if(this._vertexWithinPointerDistance(t.vertices[t.vertices.length-1].pos,e))return t.vertices.length-1}return null}_createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return St(e,(t,n,i,o)=>{const a=o==="touch"&&this._snappingEnabled;if(this.isCompleted||!a)return;const{snappingStep:s,cancelSnapping:r}=Yn({predicate:()=>a,snappingManager:this.snappingManager,snappingContext:new Pt({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:o,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles,useZ:!this._requiresScenePoint});i=i.next(c=>(a&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),c)).next(r),n.next(this._screenToMapDragEventStep()).next(c=>(c.action==="start"&&(this.stagedVertex=c.mapStart,(this.geometryType==="segment"||a&&this.numVertices===0)&&this.commitStagedVertex()),c)).next(qn(this.view,this.elevationInfo)).next(...s).next(c=>(a&&(this.stagedVertex=c.mapEnd,c.action==="end"&&this.commitStagedVertex()),c)).next(c=>(c.action==="end"&&(this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),c))})}_createManipulatorDragPipelineFreehand(e){return St(e,(t,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this.stagedVertex==null&&(this.stagedVertex=i.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this.stagedVertex=i.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return i})})}_createManipulatorDragPipelineHybrid(e){return St(e,(t,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this.stagedVertex==null&&(this.stagedVertex=i.mapStart),this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this.stagedVertex=i.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return i})})}get _drawAtFixedElevation(){return(this.geometryType==="segment"||this.geometryType==="polygon")&&this.numCommittedVertices>0}_getEffectiveDrawSurface(){if(this.elevationDrawSurface==null)return this.drawSurface;if(!this.coordinateHelper.hasZ())return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let e=this.defaultZ,t=!1;return this.elevationInfo!=null&&this.elevationInfo.mode==="absolute-height"&&(t=!0),this.snapToSceneEnabled!=null&&(t=this.snapToSceneEnabled),this.elevationInfo!=null&&this.elevationInfo.mode==="on-the-ground"&&(t=!1),this._drawAtFixedElevation&&(e=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),t=!1),t?this.drawSurface:(this.elevationDrawSurface.defaultZ=e,this.elevationDrawSurface)}_mapToScreen(e){var t;return(t=this._getEffectiveDrawSurface())==null?void 0:t.mapToScreen(e)}_onHold(e){this._snappingOperation.abort(),this.drawingMode==="click"&&e.pointerType==="touch"&&this._snappingEnabled&&(this.stagedVertex=e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if(e.pointerType==="mouse"&&e.button===2||this._manipulator.dragging)return;const t=this._activeComponent;if(this._closeOnClickVertexIndex(e.screenPoint)!=null)return e.stopPropagation(),void this.complete();const n=this._screenToMap(e.screenPoint);if(n!=null)switch(this.drawingMode){case"freehand":this.geometryType==="point"&&(this.stagedVertex!=null?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),this.complete());break;case"click":case"hybrid":this._snappingOperation.abort(),this.stagedVertex!=null?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),(this.geometryType==="point"||this.geometryType==="segment"&&t.vertices.length===2||this.geometryType==="segment"&&this.drawingMode==="hybrid"&&t.vertices.length===1)&&this.complete()}e.stopPropagation()}_onImmediateDoubleClick(e){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),e.stopPropagation())}_onPointerMove(e){const t=ce(e.x,e.y);this._stagedScreenPoint=t,this._stagedPointerType=e.pointerType;const n=this._snappingOperation,i=this._manipulator;i.dragging||this._pointerDownStates.has(e.pointerId)||i.grabbing||!i.interactive?n.abort():(e.stopPropagation(),this._updateStagedVertexOnPointerMove(t,e.pointerType))}_onViewpointChange(){const e=this._manipulator;this._stagedScreenPoint&&!e.dragging&&!e.grabbing&&e.interactive?this._updateStagedVertexOnPointerMove(this._stagedScreenPoint,this._stagedPointerType??"mouse"):this._snappingOperation.abort()}_updateStagedVertexOnPointerMove(e,t){var c;const n=this._snappingOperation,i=this._closeOnClickVertexIndex(e);if(i!=null)return this._closeOnVertex(i),void n.abort();const o=this._screenToMap(e),a=this._requiresScenePoint?(c=this.drawSurface)==null?void 0:c.screenToMap(e):null;if(o==null)return this.cursor=null,void n.abort();this.cursor="crosshair";const s=this.snappingManager;if(s==null)return this.stagedVertex=o,void n.abort();const r=this._getSnappingContext(t);this.updatingHandles.addPromise($t(n.snap({point:o,scenePoint:a},s,r)))}_closeOnVertex(e){this.stagedVertex=null;const t={componentIndex:0,vertexIndex:e,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[e].pos)};this.emit("cursor-update",{updated:null,vertices:[t],operation:"apply",type:"vertex-update"})}_screenToMap(e){var t;return(t=this._getEffectiveDrawSurface())==null?void 0:t.screenToMap(e)}_screenToMapDragEventStep(){let e=null;return t=>{if(t.action==="start"&&(e=this._screenToMap(t.screenStart)),e==null)return null;const n=this._screenToMap(t.screenEnd);return n!=null?{...t,mapStart:e,mapEnd:n}:null}}_vertexWithinPointerDistance(e,t){const i=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return i!=null&&Qn(i,t,25)}_getSnappingContext(e){const t=this._drawAtFixedElevation?on(this.elevationDrawSurface,({defaultZ:n})=>n):null;return new Pt({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e,visualizer:this.snappingVisualizer,selfSnappingZ:t!=null?{value:t,elevationInfo:this.elevationInfo}:null})}};function Qn(e,t,n){const i=e.x-t.x,o=e.y-t.y;return i*i+o*o<=n}l([p()],x.prototype,"_snappingEnabled",null),l([p()],x.prototype,"defaultZ",void 0),l([p()],x.prototype,"isDraped",void 0),l([p({value:we})],x.prototype,"drawingMode",null),l([p({constructOnly:!0})],x.prototype,"elevationDrawSurface",void 0),l([p({constructOnly:!0})],x.prototype,"elevationInfo",void 0),l([p({constructOnly:!0,type:gt})],x.prototype,"labelOptions",void 0),l([p({constructOnly:!0,type:yt})],x.prototype,"tooltipOptions",void 0),l([p({constructOnly:!0})],x.prototype,"geometryType",void 0),l([p({constructOnly:!0})],x.prototype,"hasM",void 0),l([p({constructOnly:!0})],x.prototype,"hasZ",void 0),l([p()],x.prototype,"cursor",void 0),l([p()],x.prototype,"loading",void 0),l([p({constructOnly:!0})],x.prototype,"manipulators",void 0),l([p({constructOnly:!0})],x.prototype,"drawSurface",void 0),l([p({constructOnly:!0})],x.prototype,"segmentLabels",void 0),l([p({constructOnly:!0})],x.prototype,"snappingManager",void 0),l([p({constructOnly:!0})],x.prototype,"snappingVisualizer",void 0),l([p()],x.prototype,"snapToSceneEnabled",void 0),l([p()],x.prototype,"_snappingOperation",void 0),l([p()],x.prototype,"stagedVertex",null),l([p()],x.prototype,"lastVertex",void 0),l([p()],x.prototype,"updating",null),l([p({constructOnly:!0})],x.prototype,"view",void 0),x=l([P("esri.views.draw.DrawOperation")],x);class zi{constructor(t,n,i,o=null){this._elevationInfo=t,this.defaultZ=n,this._view=i,this._excludeGraphics=o}screenToMap(t){if(this.defaultZ!=null)return this._view.sceneIntersectionHelper.intersectElevationFromScreen(kt(t.x,t.y),this._elevationInfo,this.defaultZ,this._excludeGraphics);const n=this._view.sceneIntersectionHelper.intersectElevationFromScreen(kt(t.x,t.y),this._elevationInfo,0,this._excludeGraphics);return n!=null&&(n.z=void 0),n}mapToScreen(t){const n=ye(t.x,t.y,zt(this._view,t,this._elevationInfo),t.spatialReference);return this._view.toScreen(n)}constrainZ(t){const{defaultZ:n}=this;return n!=null&&t.z!==n&&((t=ft(t)).z=n),t}}class Di{constructor(t,n,i=[]){this.view=t,this.elevationInfo=n,this.exclude=i}screenToMap(t){const n=this.view.toMap(t,{exclude:this.exclude});return n!=null&&(n.z=ut(n,this.view,this.elevationInfo)),n}mapToScreen(t){let n=t;return this.elevationInfo!=null&&(n=ye(t.x,t.y,zt(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(n)}constrainZ(t){return t}}class Fi{constructor(t,n=!1,i=0){this.view=t,this.hasZ=n,this.defaultZ=i,this.mapToScreen=o=>t.toScreen(o),this.screenToMap=n?o=>{const a=t.toMap(o);return a.z=i,a}:o=>t.toMap(o)}constrainZ(t){const{defaultZ:n}=this;return this.hasZ&&t.z!==n&&((t=ft(t)).z=n),t}}function Oe(e){return $n(e,{ignoreAlpha:!0})>225?new Et([0,0,0,e.a]):new Et([255,255,255,e.a])}function $e(e,t){const n=new Et(e);return n.a*=t,n}function ti(e=1){return $e(me.analysisTheme.accentColor,e)}function Ai(e=1){return Oe(ti(e))}function ei(e=1){return $e(me.analysisTheme.textColor,e)}function Zi(e=1){return Oe(ei(e))}function ki(e,t){return Ee(e,t,!1)}function Hi(e,t){return Ee(e,t,!0)}function Ee(e,t,n){if(e instanceof wn){if(e.operation instanceof bn)return ni(e.operation,t,n),!0;if(e.operation instanceof Tn)return ii(e.operation,t,n),!0;if(e.operation instanceof Sn)return oi(e.operation,t,n),!0}return!1}function ni(e,t,n=!1){const i=n?-1:1,o=sn(i*e.dx,i*e.dy,i*e.dz);ot(t.origin,t.origin,o)}function ii(e,t,n=!1){const i=n?-e.angle:e.angle;Ht(t.basis1,t.basis1,Ut,i),Ht(t.basis2,t.basis2,Ut,i)}function oi(e,t,n=!1){const i=n?1/e.factor1:e.factor1,o=n?1/e.factor2:e.factor2;B(t.basis1,t.basis1,i),B(t.basis2,t.basis2,o),Wt(t.origin,t.origin,e.origin,e.axis1,i),Wt(t.origin,t.origin,e.origin,e.axis2,o)}function Ui(e,t,n,i){i||(i=ve());const o=Y(it.get(),e[1],-e[0]),a=Y(it.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),s=Y(it.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),r=it.get();t.components.forEach(h=>h.vertices.forEach(g=>{const m=g.pos;Y(r,Lt(e,m),Lt(o,m)),ln(a,a,r),pn(s,s,r)}));const c=1e-6,d=Y(it.get(),s[0]-a[0]<c?n/2:0,s[1]-a[1]<c?n/2:0);return cn(a,a,d),_t(s,s,d),Nt(i.basis1,e,(s[0]-a[0])/2),Nt(i.basis2,o,(s[1]-a[1])/2),Y(i.origin,a[0]*e[0]+a[1]*o[0],a[0]*e[1]+a[1]*o[1]),_t(i.origin,i.origin,i.basis1),_t(i.origin,i.origin,i.basis2),i}function Wi(e,t,n,i=0,o){o||(o=ve()),t.toRenderCoords(e.origin,n,o.origin);const a=M.get();ot(a,e.origin,e.basis1),ot(a,a,e.basis2),t.toRenderCoords(a,n,a);const s=M.get();ot(s,e.origin,e.basis1),$(s,s,e.basis2),t.toRenderCoords(s,n,s);const r=M.get();$(r,e.origin,e.basis1),$(r,r,e.basis2),t.toRenderCoords(r,n,r);const c=M.get();$(c,e.origin,e.basis1),ot(c,c,e.basis2),t.toRenderCoords(c,n,c);const d=A(M.get(),a,s,.5);$(d,d,o.origin);const h=A(M.get(),r,c,.5);$(h,o.origin,h),A(o.basis1,d,h,.5);const g=A(M.get(),c,a,.5);$(g,g,o.origin);const m=A(M.get(),s,r,.5);$(m,o.origin,m),A(o.basis2,g,m,.5);const u=Mt(M.get(),o.basis1,o.basis2),_=Mt(u,u,o.basis1);return ae(_,_),B(o.basis2,_,oe(o.basis2,_)),B(o.basis1,o.basis1,1+i/qt(o.basis1)),B(o.basis2,o.basis2,1+i/qt(o.basis2)),En(o),o}function Li(e,t,n,i){const o=M.get();$(o,$(o,e.origin,e.basis1),e.basis2);const a=M.get();xt(a,o,e.basis1,2);const s=M.get();xt(s,a,e.basis2,2);const r=M.get();xt(r,o,e.basis2,2),o[2]=a[2]=s[2]=r[2]=t;const c=i?"on-the-ground":"absolute-height",d=jt(lt(o,a,n,c),lt(r,s,n,c)),h=jt(lt(a,s,n,c),lt(o,r,n,c));return h==null||d==null?null:[d,h]}export{qn as C,Ri as D,y as E,ki as F,Wi as G,Mi as H,x as I,Li as M,Gi as O,Vi as P,Hi as S,Vt as U,Ui as a,ei as b,Fi as c,St as d,Yn as f,ti as i,Pi as j,b as l,Di as o,Ci as q,zi as r,Zi as s,Ai as u,Ei as v,Ii as w,An as x,$i as y,Wn as z};
