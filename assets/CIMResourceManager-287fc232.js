import{bi as b,i$ as g,j0 as R,ag as f,m,ae as w}from"./index-fdfa590d.js";import{c as M}from"./fontUtils-bfde2177.js";import{s as $,C as U,b as D}from"./Rasterizer-197411b5.js";import{o as _}from"./imageutils-a2ed857b.js";async function F(a,i){const n=$(a);if(n instanceof Error)throw n;await n.createImages(),b(i);const{frames:t,width:r,height:s}=n,c=document.createElement("canvas");c.width=r,c.height=s;const o=c.getContext("2d",{willReadFrequently:!0}),d=[],l=[];for(const e of t){l.push(g(e.delay||100));const p=e.imageElement;e.blendOp===0?o.globalCompositeOperation="copy":o.globalCompositeOperation="source-over";const h=e.disposeOp===2?o.getImageData(e.left,e.top,e.width,e.height):void 0;o.drawImage(p,e.left,e.top);const u=o.getImageData(0,0,r,s);d.push(u),e.disposeOp===0||(e.disposeOp===1?o.clearRect(e.left,e.top,e.width,e.height):e.disposeOp===2&&o.putImageData(h,e.left,e.top))}return{frameDurations:l,getFrame:e=>d[e],width:r,height:s}}const I=[137,80,78,71,13,10,26,10];function O(a){const i=new Uint8Array(a);return!I.some((n,t)=>n!==i[t])}function T(a){if(!O(a))return!1;const i=new DataView(a),n=new Uint8Array(a);let t,r=8;do{const s=i.getUint32(r);if(t=String.fromCharCode.apply(String,Array.prototype.slice.call(n.subarray(r+4,r+8))),t==="acTL")return!0;r+=12+s}while(t!=="IEND"&&r<n.length);return!1}async function v(a,i){const n=U(a),t=D(n,!0),{width:r,height:s}=n.lsd,c=document.createElement("canvas");c.width=r,c.height=s;const o=c.getContext("2d",{willReadFrequently:!0}),d=[],l=[];for(const e of t){l.push(g(e.delay||100));const p=new ImageData(e.patch,e.dims.width,e.dims.height),h=_(p),u=e.disposalType===3?o.getImageData(e.dims.left,e.dims.top,e.dims.width,e.dims.height):void 0;o.drawImage(h,e.dims.left,e.dims.top);const y=o.getImageData(0,0,r,s);d.push(y),e.disposalType===1||(e.disposalType===2?o.clearRect(e.dims.left,e.dims.top,e.dims.width,e.dims.height):e.disposalType===3&&o.putImageData(u,e.dims.left,e.dims.top))}return{frameDurations:l,getFrame:e=>d[e],width:r,height:s}}const C=[71,73,70];function k(a){const i=new Uint8Array(a);return!C.some((n,t)=>n!==i[t])}function E(a){if(!k(a))return!1;const i=new DataView(a),n=i.getUint8(10);let t=13+(128&n?3*2**(1+(7&n)):0),r=0,s=!1;for(;!s;){switch(i.getUint8(t++)){case 33:if(!c())return!1;break;case 44:o();break;case 59:s=!0;break;default:return!1}if(r>1)return!0}function c(){switch(i.getUint8(t++)){case 249:d();break;case 1:l();break;case 254:e();break;case 255:p();break;default:return!1}return!0}function o(){r++,t+=8;const u=i.getUint8(t++);t+=128&u?3*2**(1+(7&u)):0,t++,h()}function d(){t++,t+=4,h()}function l(){r++,t++,t+=12,h()}function e(){h()}function p(){t++,t+=8,t+=3,h()}function h(){let u;for(;u=i.getUint8(t++);)t+=u}return!1}class V{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(i){return this._resourceMap.get(i)??null}async fetchResource(i,n){const t=this._resourceMap.get(i);if(t)return{width:t.width,height:t.height};let r=this._inFlightResourceMap.get(i);return r?r.then(s=>({width:s.width,height:s.height})):(r=L(i,n),this._inFlightResourceMap.set(i,r),r.then(s=>(this._inFlightResourceMap.delete(i),this._resourceMap.set(i,s),{width:s.width,height:s.height}),()=>({width:0,height:0})))}deleteResource(i){this._inFlightResourceMap.delete(i),this._resourceMap.delete(i)}loadFont(i){return M(i)}}async function x(a,i){const n=window.URL.createObjectURL(a);try{const{data:t}=await f(n,{...i,responseType:"image"});return t}catch(t){throw m(t)?t:new w("mapview-invalid-resource",`Could not fetch requested resource at ${n}`)}finally{window.URL.revokeObjectURL(n)}}async function L(a,i){const{arrayBuffer:n,mediaType:t}=await j(a,i),r=t==="image/png";return t==="image/gif"&&E(n)?v(n):r&&T(n)?F(n,i):x(new Blob([n],{type:t}),i)}async function j(a,i){let n;const t=";base64,";if(a.includes(t)){const r=a.indexOf(t),s=a.indexOf(t)+t.length,c=a.substring(s);n={arrayBuffer:R(c),mediaType:a.substring(0,r).replace("data:","")}}else try{const r=await f(a,{responseType:"array-buffer",...i});n={arrayBuffer:r.data,mediaType:r.getHeader("Content-Type")}}catch(r){if(!m(r))throw new w("mapview-invalid-resource",`Could not fetch requested resource at ${a}`)}return n}export{V as h};
