import{ce as C,cd as k,hA as ft,cn as Tt,jh as Ot,cf as mt,ji as g,bE as A,jj as Rt,df as D,cy as Z,cc as tt,jk as pt,bF as T}from"./index-a6c97245.js";import{s as at,d as et,k as Et,a as At,r as bt,q,p as nt,e as $,z,V as ot,_ as P}from"./sphere-812d69dd.js";import{h as p,p as Ft,_ as I,G as Nt}from"./plane-f0d62c60.js";import{i as it}from"./InterleavedLayout-ddec9a00.js";function X(o){return o?{ray:et(o.ray),c0:o.c0,c1:o.c1}:{ray:et(),c0:0,c1:Number.MAX_VALUE}}function vt(o,t=X()){return Et(o,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function wt(o,t){return dt(o,o.c0,t)}function Ct(o,t){return dt(o,o.c1,t)}function dt(o,t,e){return C(e,o.ray.origin,k(e,o.ray.direction,t))}new at(()=>X());function kt(o){return o?[p(o[0]),p(o[1]),p(o[2]),p(o[3]),p(o[4]),p(o[5])]:[p(),p(),p(),p(),p(),p()]}function gt(){return[A(),A(),A(),A(),A(),A(),A(),A()]}function qt(o,t){for(let e=0;e<Q;e++)Ft(o[e],t[e])}function $t(o,t,e,n=jt){const i=ft(At.get(),t,o);Tt(i,i);for(let r=0;r<St;++r){const s=Ot(bt.get(),Bt[r],i);mt(n[r],s[0]/s[3],s[1]/s[3],s[2]/s[3])}Mt(e,n)}function Mt(o,t){I(t[h.FAR_BOTTOM_LEFT],t[h.NEAR_BOTTOM_LEFT],t[h.NEAR_TOP_LEFT],o[M.LEFT]),I(t[h.NEAR_BOTTOM_RIGHT],t[h.FAR_BOTTOM_RIGHT],t[h.FAR_TOP_RIGHT],o[M.RIGHT]),I(t[h.FAR_BOTTOM_LEFT],t[h.FAR_BOTTOM_RIGHT],t[h.NEAR_BOTTOM_RIGHT],o[M.BOTTOM]),I(t[h.NEAR_TOP_LEFT],t[h.NEAR_TOP_RIGHT],t[h.FAR_TOP_RIGHT],o[M.TOP]),I(t[h.NEAR_BOTTOM_LEFT],t[h.NEAR_BOTTOM_RIGHT],t[h.NEAR_TOP_RIGHT],o[M.NEAR]),I(t[h.FAR_BOTTOM_RIGHT],t[h.FAR_BOTTOM_LEFT],t[h.FAR_TOP_LEFT],o[M.FAR])}function y(o,t){for(let e=0;e<Q;e++){const n=o[e];if(n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]>=t[3])return!1}return!0}function Kt(o,t){for(let e=0;e<Q;e++){const n=o[e];if(!Nt(n,t))return!1}return!0}var M,h;(function(o){o[o.LEFT=0]="LEFT",o[o.RIGHT=1]="RIGHT",o[o.BOTTOM=2]="BOTTOM",o[o.TOP=3]="TOP",o[o.NEAR=4]="NEAR",o[o.FAR=5]="FAR"})(M||(M={})),function(o){o[o.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",o[o.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",o[o.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",o[o.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",o[o.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",o[o.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",o[o.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",o[o.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(h||(h={}));h.FAR_BOTTOM_RIGHT,h.NEAR_BOTTOM_RIGHT,h.NEAR_BOTTOM_LEFT,h.FAR_BOTTOM_LEFT,h.NEAR_BOTTOM_LEFT,h.NEAR_BOTTOM_RIGHT,h.NEAR_TOP_RIGHT,h.NEAR_TOP_LEFT,h.FAR_BOTTOM_RIGHT,h.FAR_BOTTOM_LEFT,h.FAR_TOP_LEFT,h.FAR_TOP_RIGHT,h.NEAR_BOTTOM_RIGHT,h.FAR_BOTTOM_RIGHT,h.FAR_TOP_RIGHT,h.NEAR_TOP_RIGHT,h.FAR_BOTTOM_LEFT,h.NEAR_BOTTOM_LEFT,h.NEAR_TOP_LEFT,h.FAR_TOP_LEFT,h.FAR_TOP_LEFT,h.NEAR_TOP_LEFT,h.NEAR_TOP_RIGHT,h.FAR_TOP_RIGHT;const Q=6,St=8,Bt=[g(-1,-1,-1,1),g(1,-1,-1,1),g(1,1,-1,1),g(-1,1,-1,1),g(-1,-1,1,1),g(1,-1,1,1),g(1,1,1,1),g(-1,1,1,1)];new at(X);const jt=gt();class x{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,e){this.objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),U[0]=null,B.prune(),j.prune()}add(t,e=t.length){this._objectCount+=e,this._grow(t,e);const n=l.acquire();for(let i=0;i<e;i++){const r=t[i];this._isDegenerate(r)?this._degenerateObjects.add(r):(n.init(this._root),this._add(r,n))}l.release(n)}remove(t,e=null){this._objectCount-=t.length;const n=l.acquire();for(const i of t){const r=e??q(this.objectToBoundingSphere(i),Ht);G(r[3])?(n.init(this._root),this._remove(i,r,n)):this._degenerateObjects.delete(i)}l.release(n),this._shrink()}update(t,e){if(!G(e[3])&&this._isDegenerate(t))return;const n=Lt(t);this.remove(n,e),this.add(n)}forEachAlongRay(t,e,n){const i=nt(t,e);this._forEachNode(this._root,r=>{if(!this._intersectsNode(i,r))return!1;const s=r.node;return s.terminals.forAll(d=>{this._intersectsObject(i,d)&&n(d)}),s.residents!==null&&s.residents.forAll(d=>{this._intersectsObject(i,d)&&n(d)}),!0})}forEachAlongRayWithVerticalOffset(t,e,n,i){const r=nt(t,e);this._forEachNode(this._root,s=>{if(!this._intersectsNodeWithOffset(r,s,i))return!1;const d=s.node;return d.terminals.forAll(a=>{this._intersectsObjectWithOffset(r,a,i)&&n(a)}),d.residents!==null&&d.residents.forAll(a=>{this._intersectsObjectWithOffset(r,a,i)&&n(a)}),!0})}forEach(t){this._forEachNode(this._root,e=>{const n=e.node;return n.terminals.forAll(t),n.residents!==null&&n.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,n,i=()=>!0,r=1/0){let s=1/0,d=1/0,a=null;const c=K(t,e),f=u=>{if(--r,!i(u))return;const O=this.objectToBoundingSphere(u);if(!y(n,O))return;const b=S(t,e,z(O)),L=b-O[3],_=b+O[3];L<s&&(s=L,d=_,a=u)};return this._forEachNodeDepthOrdered(this._root,u=>{if(r<=0||!y(n,u.bounds)||(k(E,c,u.halfSize),C(E,E,u.bounds),S(t,e,E)>d))return!1;const O=u.node;return O.terminals.forAll(b=>f(b)),O.residents!==null&&O.residents.forAll(b=>f(b)),!0},t,e),a}forEachInDepthRange(t,e,n,i,r,s,d){let a=-1/0,c=1/0;const f={setRange:_=>{n===x.DepthOrder.FRONT_TO_BACK?(a=Math.max(a,_.near),c=Math.min(c,_.far)):(a=Math.max(a,-_.far),c=Math.min(c,-_.near))}};f.setRange(i);const u=S(e,n,t),O=K(e,n),b=K(e,-n),L=_=>{if(!d(_))return;const N=this.objectToBoundingSphere(_),H=z(N),Y=S(e,n,H)-u,ct=Y-N[3],_t=Y+N[3];ct>c||_t<a||!y(s,N)||r(_,f)};this._forEachNodeDepthOrdered(this._root,_=>{if(!y(s,_.bounds)||(k(E,O,_.halfSize),C(E,E,_.bounds),S(e,n,E)-u>c)||(k(E,b,_.halfSize),C(E,E,_.bounds),S(e,n,E)-u<a))return!1;const N=_.node;return N.terminals.forAll(H=>L(H)),N.residents!==null&&N.residents.forAll(H=>L(H)),!0},e,n)}forEachNode(t){this._forEachNode(this._root,e=>t(e.node,e.bounds,e.halfSize,e.depth))}forEachNeighbor(t,e){const n=$(e),i=z(e),r=a=>{const c=this.objectToBoundingSphere(a),f=$(c),u=n+f;return!(Z(z(c),i)-u*u<=0)||t(a)};let s=!0;const d=a=>{s&&(s=r(a))};this._forEachNode(this._root,a=>{const c=$(a.bounds),f=n+c;if(Z(z(a.bounds),i)-f*f>0)return!1;const u=a.node;return u.terminals.forAll(d),s&&u.residents!==null&&u.residents.forAll(d),s}),s&&this.forEachDegenerateObject(d)}_intersectsNode(t,e){return v(e.bounds,2*-e.halfSize,m),v(e.bounds,2*e.halfSize,R),it(t.origin,t.direction,m,R)}_intersectsNodeWithOffset(t,e,n){return v(e.bounds,2*-e.halfSize,m),v(e.bounds,2*e.halfSize,R),n.applyToMinMax(m,R),it(t.origin,t.direction,m,R)}_intersectsObject(t,e){const n=this.objectToBoundingSphere(e);return!(n[3]>0)||ot(n,t)}_intersectsObjectWithOffset(t,e,n){const i=this.objectToBoundingSphere(e);return!(i[3]>0)||ot(n.applyToBoundingSphere(i),t)}_forEachNode(t,e){let n=l.acquire().init(t);const i=[n];for(;i.length!==0;){if(n=i.pop(),e(n)&&!n.isLeaf())for(let r=0;r<n.node.children.length;r++)n.node.children[r]&&i.push(l.acquire().init(n).advance(r));l.release(n)}}_forEachNodeDepthOrdered(t,e,n,i=x.DepthOrder.FRONT_TO_BACK){let r=l.acquire().init(t);const s=[r];for(Pt(n,i,ht);s.length!==0;){if(r=s.pop(),e(r)&&!r.isLeaf())for(let d=7;d>=0;--d){const a=ht[d];r.node.children[a]&&s.push(l.acquire().init(r).advance(a))}l.release(r)}}_remove(t,e,n){B.clear();const i=n.advanceTo(e,(r,s)=>{B.push(r.node),B.push(s)})?n.node.terminals:n.node.residents;if(i.removeUnordered(t),i.length===0)for(let r=B.length-2;r>=0;r-=2){const s=B.data[r],d=B.data[r+1];if(!this._purge(s,d))break}}_nodeIsEmpty(t){if(t.terminals.length!==0)return!1;if(t.residents!==null)return t.residents.length===0;for(let e=0;e<t.children.length;e++)if(t.children[e])return!1;return!0}_purge(t,e){return e>=0&&(t.children[e]=null),!!this._nodeIsEmpty(t)&&(t.residents===null&&(t.residents=new D({shrink:!0})),!0)}_add(t,e){e.advanceTo(this.objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let n=0;n<e.length;n++){const i=l.acquire().init(t);this._add(e.at(n),i),l.release(i)}}_grow(t,e){if(e!==0&&(rt(t,e,n=>this.objectToBoundingSphere(n),F),G(F[3])&&!this._fitsInsideTree(F)))if(this._nodeIsEmpty(this._root.node))q(F,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const n=this._rootBoundsForRootAsSubNode(F);this._placingRootViolatesMaxDepth(n)?this._rebuildTree(F,n):this._growRootAsSubNode(n),l.release(n)}}_rebuildTree(t,e){tt(V,e.bounds),V[3]=e.halfSize,rt([t,V],2,i=>i,J);const n=l.acquire().init(this._root);this._root.initFrom(null,J,J[3]),this._root.increaseHalfSize(1.25),this._forEachNode(n,i=>(this.add(i.node.terminals.data,i.node.terminals.length),i.node.residents!==null&&this.add(i.node.residents.data,i.node.residents.length),!0)),l.release(n)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return this._forEachNode(this._root,i=>(n=Math.max(n,i.depth),n+e<=this._maximumDepth)),n+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],n=t;let i=-1/0;const r=this._root.bounds,s=this._root.halfSize;for(let a=0;a<3;a++){const c=r[a]-s-(n[a]-e),f=n[a]+e-(r[a]+s),u=Math.max(0,Math.ceil(c/(2*s))),O=Math.max(0,Math.ceil(f/(2*s)))+1,b=2**Math.ceil(Math.log(u+O)*Math.LOG2E);i=Math.max(i,b),w[a].min=u,w[a].max=O}for(let a=0;a<3;a++){let c=w[a].min,f=w[a].max;const u=(i-(c+f))/2;c+=Math.ceil(u),f+=Math.floor(u);const O=r[a]-s-c*s*2;W[a]=O+(f+c)*s}const d=i*s;return W[3]=d*ut,l.acquire().initFrom(null,W,d,0)}_growRootAsSubNode(t){const e=this._root.node;tt(F,this._root.bounds),F[3]=this._root.halfSize,this._root.init(t),t.advanceTo(F,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let n=0,i=0;for(;i<e.length&&t==null;)n=i++,t=e[n];for(;i<e.length;)if(e[i++])return-1;return n}_isDegenerate(t){return!G(this.objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,n=this._root.halfSize;return t[3]<=n&&t[0]>=e[0]-n&&t[0]<=e[0]+n&&t[1]>=e[1]-n&&t[1]<=e[1]+n&&t[2]>=e[2]-n&&t[2]<=e[2]+n}toJSON(){const{maximumDepth:t,maximumObjectsPerNode:e,_objectCount:n}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:t,maximumObjectsPerNode:e,objectCount:n,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(t){var r,s;const e=t.children.map(d=>d?this._nodeToJSON(d):null),n=(r=t.residents)==null?void 0:r.map(d=>this.objectToBoundingSphere(d)),i=(s=t.terminals)==null?void 0:s.map(d=>this.objectToBoundingSphere(d));return{children:e,residents:n,terminals:i}}static fromJSON(t){const e=new x(n=>n,{maximumDepth:t.maximumDepth,maximumObjectsPerNode:t.maximumObjectsPerNode});return e._objectCount=t.objectCount,e._root.initFrom(t.root.node,t.root.bounds,t.root.halfSize,t.root.depth),e}}class l{constructor(){this.bounds=P(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,n,i=this.depth){return this.node=t??l.createEmptyNode(),e!=null&&q(e,this.bounds),this.halfSize=n,this.depth=i,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*ut}advance(t){let e=this.node.children[t];e||(e=l.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const n=lt[t];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,e,n=!1){for(;;){if(this.isTerminalFor(t))return e&&e(this,-1),!0;if(this.isLeaf()){if(!n)return e&&e(this,-1),!1;this.node.residents=null}const i=this._childIndex(t);e&&e(this,i),this.advance(i)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new D({shrink:!0}),residents:new D({shrink:!0})}}static acquire(){return l._pool.acquire()}static release(t){l._pool.release(t)}static clearPool(){l._pool.prune()}}function xt(o,t){o[0]=Math.min(o[0],t[0]-t[3]),o[1]=Math.min(o[1],t[1]-t[3]),o[2]=Math.min(o[2],t[2]-t[3])}function It(o,t){o[0]=Math.max(o[0],t[0]+t[3]),o[1]=Math.max(o[1],t[1]+t[3]),o[2]=Math.max(o[2],t[2]+t[3])}function v(o,t,e){e[0]=o[0]+t,e[1]=o[1]+t,e[2]=o[2]+t}function rt(o,t,e,n){if(t===1){const i=e(o[0]);q(i,n)}else{m[0]=1/0,m[1]=1/0,m[2]=1/0,R[0]=-1/0,R[1]=-1/0,R[2]=-1/0;for(let i=0;i<t;i++){const r=e(o[i]);G(r[3])&&(xt(m,r),It(R,r))}pt(n,m,R,.5),n[3]=Math.max(R[0]-m[0],R[1]-m[1],R[2]-m[2])/2}}function Pt(o,t,e){if(!j.length)for(let n=0;n<8;++n)j.push({index:0,distance:0});for(let n=0;n<8;++n){const i=lt[n];j.data[n].index=n,j.data[n].distance=S(o,t,i)}j.sort((n,i)=>n.distance-i.distance);for(let n=0;n<8;++n)e[n]=j.data[n].index}function K(o,t){let e,n=1/0;for(let i=0;i<8;++i){const r=S(o,t,st[i]);r<n&&(n=r,e=st[i])}return e}function S(o,t,e){return t*(o[0]*e[0]+o[1]*e[1]+o[2]*e[2])}function G(o){return!isNaN(o)&&o!==-1/0&&o!==1/0&&o>0}l._pool=new Rt(l),function(o){var t;(t=o.DepthOrder||(o.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(x||(x={}));const lt=[T(-1,-1,-1),T(1,-1,-1),T(-1,1,-1),T(1,1,-1),T(-1,-1,1),T(1,-1,1),T(-1,1,1),T(1,1,1)],st=[T(-1,-1,-1),T(-1,-1,1),T(-1,1,-1),T(-1,1,1),T(1,-1,-1),T(1,-1,1),T(1,1,-1),T(1,1,1)],ut=Math.sqrt(3),U=[null];function Lt(o){return U[0]=o,U}const W=P(),E=A(),m=A(),R=A(),B=new D,Ht=P(),F=P(),V=P(),J=P(),w=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],j=new D,ht=[0,0,0,0,0,0,0,0],Wt=x;export{kt as I,qt as L,Wt as W,X as a,Ct as g,M as l,Kt as m,wt as p,$t as s,vt as y};
